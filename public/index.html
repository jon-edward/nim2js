<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Nim2JS Browser Test</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 2em;
      }
      textarea {
        width: 100%;
        height: 200px;
      }
      pre {
        background: #f4f4f4;
        padding: 1em;
      }
      #output {
        max-height: 300px;
        overflow: auto;
        white-space: pre-wrap;
      }
      #runtimeConsole {
        background: #111;
        color: #dff;
        padding: 1em;
        height: 200px;
        overflow: auto;
        white-space: pre-wrap;
        font-family: monospace;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="nim-codemirror.js"></script>
  </head>
  <body>
    <h1>Nim2JS Browser Test</h1>
    <p>
      Write Nim code below and click "Compile". See the source code at
      <a href="https://github.com/jon-edward/nim2js"
        >https://github.com/jon-edward/nim2js</a
      >.
    </p>
    <textarea id="nimSrc">echo "Hello from Nim!"</textarea>
    <br />
    <button id="runBtn">Compile</button>
    <button id="runJsBtn">Run JS</button>
    <h2>Output</h2>
    <div
      style="display: flex; gap: 8px; align-items: center; margin-bottom: 6px"
    >
      <button id="copyOutputBtn">Copy</button>
    </div>
    <pre id="output"></pre>
    <h2>Runtime Console</h2>
    <pre id="runtimeConsole"></pre>
    <script src="nim2js.js"></script>
    <script>
      // Initialize CodeMirror on the textarea.
      const editorSrc = CodeMirror.fromTextArea(
        document.getElementById("nimSrc"),
        {
          lineNumbers: true,
          mode: "nim",
          theme: "default",
          tabSize: 2,
        }
      );

      const readOnlyJs = CodeMirror(document.getElementById("output"), {
        theme: "default",
        mode: "javascript",
        lineNumbers: true,
        readOnly: true, // This makes the editor uneditable
      });

      function nim2js(nimCode) {
        if (typeof Module === "undefined") {
          return "Error: Nim2JS module not loaded.";
        }
        return Module.ccall("nim2js", "string", ["string"], [nimCode]);
      }

      document.getElementById("runBtn").addEventListener("click", () => {
        const output = document.getElementById("output");
        readOnlyJs.setValue(nim2js(editorSrc.getValue()));
      });

      // Copy output to clipboard with navigator API and fallback
      async function copyOutput() {
        const text = readOnlyJs.getValue() || "";
        if (!text) return alert("Nothing to copy.");
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            const ta = document.createElement("textarea");
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
          }
          const btn = document.getElementById("copyOutputBtn");
          const orig = btn.textContent;
          btn.textContent = "Copied!";
          setTimeout(() => (btn.textContent = orig), 1200);
        } catch (e) {
          alert("Copy failed: " + e);
        }
      }

      document
        .getElementById("copyOutputBtn")
        .addEventListener("click", copyOutput);

      // Execute the JavaScript shown in the `#output` element and capture console output.
      function runOutputJS() {
        const consoleEl = document.getElementById("runtimeConsole");
        const code = readOnlyJs.getValue() || "";
        consoleEl.textContent = "";
        if (!code.trim()) {
          consoleEl.textContent = "No JavaScript found in output.";
          return;
        }

        const logs = [];
        const origConsole = window.console;
        const fakeConsole = {
          log(...args) {
            logs.push(args.map(String).join(" "));
          },
          info(...args) {
            logs.push(args.map(String).join(" "));
          },
          warn(...args) {
            logs.push("WARN: " + args.map(String).join(" "));
          },
          error(...args) {
            logs.push("ERROR: " + args.map(String).join(" "));
          },
          clear() {
            logs.length = 0;
          },
        };

        function flush() {
          consoleEl.textContent = logs.join("\n");
        }

        try {
          // Temporarily replace the global console so code uses our capture.
          window.console = fakeConsole;
          // Evaluate in global scope so top-level declarations behave like a script.
          (0, eval)(code);
        } catch (e) {
          logs.push("Exception: " + (e && e.stack ? e.stack : e));
        } finally {
          // Restore original console and flush captured logs.
          window.console = origConsole;
          flush();
        }
      }

      document
        .getElementById("runJsBtn")
        .addEventListener("click", runOutputJS);
    </script>
  </body>
</html>
